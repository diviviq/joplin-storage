Изучаем Adversarial Tactics, Techniques & Common Knowledge (ATT@CK). Часть 4

**Ссылки на все части:**  
[Часть 1\. Получение первоначального доступа](https://habr.com/post/423405/)  
[Часть 2\. Выполнение](https://habr.com/post/424027/)  
[Часть 3\. Закрепление](https://habr.com/post/425177/)  
[Часть 4\. Повышение привилегий](https://habr.com/post/428602/)  
[Часть 5\. Обход защиты](https://habr.com/post/432624/)

Эскалация привилегий — это результат действий, которые позволяют злоумышленнику или вредоносной программе получить более высокий уровень разрешений в атакуемой системе или сети. Техники эскалации привилегий описывают методы, с помощью которых противник, получив непривилегированный доступ в атакуемую систему, используя различные «слабости» системы может получить права локального администратора, system или root. Использование злоумышленниками учетных записей пользователей с правами доступа к конкретным системам или разрешениями на выполнения определенных операций также может рассматриваться как эскалация привилегий.  
  
_Автор не несет ответственности за возможные последствия применения изложенной в статье информации, а также просит прощения за возможные неточности, допущенные в некоторых формулировках и терминах. Публикуемая информация является свободным пересказом содержания [MITRE ATT&CK](https://attack.mitre.org/wiki/Main_Page)._

Важно отменить, что некоторые техники, описываемые в матрице [ATT@CK](https://attack.mitre.org/), одновременно включены в несколько этапов цепочки атаки, например, перехват поиска DLL может использоваться как для закрепления доступа путём несанкционированного выполнения вредоносной DLL, так и для повышения привилегий путём запуска DLL в процессе, работающем в контексте более привилегированного пользователя.

### [Манипуляции с маркерами доступа (Access Token Manipulation)](https://attack.mitre.org/wiki/Technique/T1134)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ Злоумышленники могут использовать маркеры доступа (Access Token), чтобы совершать свои действия в различных пользовательских или системном контекстах безопасности, таким образом избегая обнаружения вредоносной активности. Противник может использовать функции Windows API для копирования маркеров доступа из существующих процессов (Token stealing), для этого он должен находиться в контексте привилегированного пользователя (например, администратора). Кража маркеров доступа обычно используется для повышения привилегий с уровня администратора до уровня System. Противник также может использовать маркер доступа учетной записи для аутентификации в удаленной системе, если у этой учетной записи есть нужные разрешения в удаленной системе.  
Рассмотрим несколько способов злоупотребления маркерами доступа:

*   Кража и олицетворение токенов. Олицетворение токенов — это способность ОС запускать потоки в контексте безопасности, отличном от контекста процесса, которому принадлежит этот поток. Другими словами, олицетворение токенов позволяет совершать какие-либо действия от имени другого пользователя. Противник может создать дубликат маркера доступа с помощью функции _DuplicateTokenEX_ и использовать _ImpersonateLoggedOnUser_, чтобы вызвать поток в контексте залогиненного пользователя или использовать _SetThreadToken_, чтобы назначить маркер доступа в поток.
*   Создание процесса с помощью маркера доступа. Злоумышленник может создать маркер доступа с помощью функции _DuplicateTokenEX_ и далее использовать его с _CreateProcessWithTokenW_ для создания нового процесса, работающего в контексте олицетворяемого пользователя.
*   Получение и олицетворение маркеров доступа. Противник, имея логин и пароль пользователя, может создать сеанс входа в систему с помощью API-функции _LogonUser_, которая вернёт копию сессионного маркера доступа нового сеанса, и далее с помощью функции _SetThreadToken_ назначить маркер для потока. Metasploit Meterpreter и CobaltStrike имеют инструментарий для манипуляций с маркерами доступа с целью повышения привилегий.

_Рекомендации по защите:_ Чтобы в полной мере использовать вышеописанную тактику злоумышленник должен обладать правами администратора системы, поэтому не забывайте ограничивать привилегии обычных пользователей. Любой пользователь может обмануть маркеры доступа если у него есть легитимные учетные данные. Ограничьте возможность создания пользователями и группами маркеров доступа:  
_GPO: Computer Configuration > \[Policies\] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Create a token object_  
Так же определите, кто может заменять маркеры процессов локальных или сетевых служб:  
_GPO: Computer Configuration > \[Policies\] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Replace a process level token_

### [Модификация исполняемых файлов приложений «специальные возможности Windows» (Accessibility Features)](https://attack.mitre.org/wiki/Technique/T1015)

_Система:_ Windows  
_Права:_ Администратор  
_Описание:_ Приложения «специальные возможности» (экранная лупа, экранная клавиатура и т.п.) могут запускаться с помощью комбинаций клавиш до входа пользователя в систему. Злоумышленник может подменить файлы запуска этих программ или изменить способ их запуска и открыть командную консоль или получить бэкдор без входа в систему.

*   _C:\\Windows\\System32\\sethc.exe_ — запускается 5-кратным нажатием клавиши Shift;
*   _C:\\Windows\\System32\\utilman.exe_ — запускается нажатием комбинации Win+U.

В WinXP и более поздних версиях sethc.exe и utilman.exe могут быть заменены, например, на cmd.exe, впоследствии при нажатии нужной комбинации клавиш cmd.exe запуститься до входа в Windows с привилегиями System.  
В Vista и более поздних версиях нужно изменить ключ реестра, который настраивает cmd.exe или другую программу в качестве отладчика, например, для ultiman.exe. После правки реестра и нажатии нужной комбинации клавиш на экране входа в систему или при подключении к хосту по RDP выполнится cmd.exe с правами System.  
Есть ещё программы Windows, которые могут использоваться при реализации данной техники атаки:  

_*   C:\\Windows\\System32\\osk.exe;
*   C:\\Windows\\System32\\Magnify.exe;
*   C:\\Windows\\System32\\Narrator.exe;
*   C:\\Windows\\System32\\DisplaySwitch.exe;
*   C:\\Windows\\System32\\AtBroker.exe._

  
_Рекомендации по защите:_ Настройте запуск обязательной сетевой аутентификации удаленных пользователей до создания RDP-сеанса и отображения экрана входа в систему (_включено по умолчанию в Windows Vista и более поздних версиях_). Используйте Remote Desktop Gateway для управления соединениями и настройкой безопасности RDP.

### [Модификация ключа AppCert DLLs](https://attack.mitre.org/wiki/Technique/T1182)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Библиотеки DLL, указанные в значении ключа AppCertDLLs загружаются в каждый процесс, который вызывает часто используемые функции API: _CreateProcess, CreateProcessAsUser, CreateProcessWithLoginW, CreateProcessWithTokenW, WinExec_. Значением ключа AppCertDLLs можно злоупотреблять, вызвав загрузку вредоносной DLL и запустив определенные процессы. AppCertDLLs хранится в следующем разделе реестра:  
_HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager_.

_Рекомендации по защите:_ Применяйте всевозможные средства блокировки потенциально-опасного программного обеспечения и загрузки неизвестных DLL-библиотек, например AppLocker и DeviceGuard.

### [Модификация ключа AppInit DLLs](https://attack.mitre.org/wiki/Technique/T1103)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ DLL-библиотеки, указанные в значении ключа AppInit_DLLs, загружаются в каждый процесс, который загружает user32.dll. На практике, это почти каждая программа.  
AppInit_DLLs хранится в следующих разделах реестра:

*   _HKEY\_LOCAL\_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows;_
*   _HKEY\_LOCAL\_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows._

Значением ключа AppInit\_DLLs можно злоупотреблять для превышения привилегий, загружая вредоносные DLL и запуская определенные процессы. Функциональность AppInit\_DLLs отключена в Windows 8 и более поздних версиях, когда активирована безопасная загрузка.

_Рекомендации по защите:_ Рассмотрите возможность использования ОС версии не ранее Windows 8 и включения безопасной загрузки. Применяйте всевозможные средства блокировки потенциально-опасного программного обеспечения и загрузки неизвестных DLL-библиотек, например AppLocker и DeviceGuard.

### [Злоупотребление подсистемой совместимости приложений (Application Shimming)](https://attack.mitre.org/wiki/Technique/T1138)

_Система:_ Windows  
_Права:_ Администратор  
_Описание:_ _Microsoft Windows Application Compatibility Infrastructure/Framework_ создана для обеспечения совместимости программ с обновлениями Windows и изменениями кода ОС. Система совместимости использует так называемые shim («прокладки») — библиотеки, выступающие в качестве буфера между программой и ОС. С помощью shim-кэша система определяет необходимость использования shim-прокладок (хранятся в виде БД типа .sdb). В файлах .sdb хранятся различные процедуры для перехвата кода приложения, его обработки и дальнейшего перенаправления в ОС. Перечень всех shim-прокладок, установленных установщиком (sdbinst.exe) по умолчанию храниться в:

*   _%WINDIR%\\AppPatch\\sysmain.sdb_;
*   _HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB_.

Кастомные shim-базы хранятся в:

*   _%WINDIR%\\AppPatch\[64\]\\Custom;_
*   _HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom_.

Для обеспечения защиты в пользовательском режиме исключена возможность изменения ядра ОС c помощью shim-прокладок, а для их установки необходимы права администратора. Однако некоторые shim-прокладки могут использоваться для обхода контроля учетных записей (UAC), DLL-инъекций, отключения [Data Execution Prevention](https://support.microsoft.com/ru-ru/help/875352.) и [Srtucture Exception Handling](https://docs.microsoft.com/ru-ru/windows/desktop/Debug/structured-exception-handling), а так же перехвата адресов памяти. Использование злоумышленником shim-прокладок позволяет повысить привилегии, установить бэкдоры, отключить защиту ОС, например Защитник Windows.

_Рекомендации по защите:_ Способов предотвращения Application shiming не так много. Отключение совместимости приложений не рекомендуется во избежание проблем со стабильностью работы ОС. Microsoft выпустила [KB3045645](https://www.microsoft.com/ru-ru/download/details.aspx?id=46804), которое удалит флаг «auto-elevate» в файле sdbinst.exe для предотвращения использования shim-системы для обхода UAC.

### [Обход контроля учетных записей (Bypass User Account Control)](https://attack.mitre.org/wiki/Technique/T1088)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ Известно множество способов обхода UAC, самые распространенные из которых реализованы в проекте [UACMe](https://github.com/hfiref0x/UACME). Регулярно обнаруживаются новые способы обхода UAC, подобные злоупотреблению системным приложением [eventvwr.exe](https://www.fortinet.com/blog/threat-research/malicious-macro-bypasses-uac-to-elevate-privilege-for-fareit-malware.html), которое может выполнить бинарный файл или скрипт с повышенными правами. Вредоносные программы также могут быть внедрены в доверенные процессы, которым UAC разрешает повышение привилегий не запрашивая пользователя.  
Для обхода UAC с помощью eventvwr.exe в реестре Windows модифицируется ключ:  
_\[HKEY\_CURRENT\_USER\]\\Software\\Classes\\mscfile\\shell \\open\\command_.  
Для обхода UAC с помощью sdclt.exe в реестре Windows модифицируются ключи:  
_\[HKEY\_CURRENT\_USER\]\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths\\control.exe;  
\[HKEY\_CURRENT\_USER\]\\Software\\Classes\\exefile\\shell\\runas\\command\\isolatedCommand._

_Рекомендации по защите:_ Удаляйте пользователей из локальной группы администраторов в защищаемых системах. По возможности включите в параметрах UAC наивысший уровень защиты.

### [Перехват поиска DLL (DLL Search Order Hijacking)](https://attack.mitre.org/wiki/Technique/T1038)

_Система:_ Windows  
_Права:_ Пользователь, Администратор, System  
_Описание:_ Техника заключается в эксплуатации уязвимостей алгоритма поиска приложениями файлов DLL, необходимых им для работы ([MSA2269637](https://technet.microsoft.com/ru-ru/library/security/2269637.aspx)). Зачастую директорией поиска DLL является рабочий каталог программы, поэтому злоумышленники могут подменять исходную DLL на вредоносную с тем же именем файла.  
Удаленные атаки на поиск DLL могут проводиться когда программа устанавливает свой текущий каталог в удаленной директории, например, сетевую шару. Также злоумышленники могут напрямую менять способ поиска и загрузки DLL заменяя файлы .manifest или .local, в которых описываются параметры поиска DLL. Если атакуемая программа работает с высоким уровнем привилегий, то подгруженная ею вредоносная DLL также будет выполняться с высокими правами. В этом случае техника может использоваться для повышения привилегий от пользователя до администратора или System.

_Рекомендации по защите:_ Запрет удаленной загрузки DLL (включено по умолчанию в Windows Server 2012+ и доступно с обновлениями для XP+ и Server 2003+). Включение безопасного режима поиска DLL, который ограничит каталоги поиска директориями типа _%SYSTEMROOT%_ до выполнения поиска DLL в текущей директории приложения.  
Включение режима безопасного поиска DLL:  
_Computer Configuration > \[Policies\] > Administrative Templates > MSS (Legacy): MSS: (SafeDllSearchMode) Enable Safe DLL search mode._  
Соответствующий ключ реестра:  
_HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\SafeDLLSearchMode._

Рассмотрите целесообразность аудита защищаемой системы для устранения недостатков DLL с помощью таких инструментов как модуль PowerUP в PowerSploit. Не забывайте про блокировку вредоносного и потенциально-опасного ПО, а так же выполнение [рекомендаций Microsoft](https://docs.microsoft.com/ru-ru/windows/desktop/Dlls/dynamic-link-library-security).

### [Перехват поиска Dylib (Dylib Hijacking)](https://attack.mitre.org/wiki/Technique/T1157)

_Система:_ macOS  
_Права:_ Пользователь  
Описание: Техника основана на [уязвимостях алгоритмов поиска динамических библиотек dylib в macOS и OS X](https://s3.amazonaws.com/s3.synack.com/canSecW.pdf). Суть заключается в определении dylib, которые подгружает атакуемое приложение и последующем размещении вредоносной версии dylib с тем же именем в рабочей директории приложения. Это приведёт к загрузке приложением dylib, которая размещена в рабочем каталоге программы. При этом вредоносная Dylib будет выполнятся с правами доступа атакуемого приложения.

_Рекомендации по защите:_ Запрет записи пользователями файлов в каталоги поиска dylib. Аудит уязвимостей с помощью [Dylib Hijacking Scanner](https://objective-see.com/products/dhs.html) от Objective-See.

### [Эксплуатация уязвимостей для повышения привилегий (Exploitation for Privilege Escalation)](https://attack.mitre.org/wiki/Technique/T1068)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Противники могут повысить привилегии в атакуемой системе используя уязвимости в программном обеспечении.

_Рекомендации по защите:_ Регулярное обновление ПО на всех защищаемых рабочих станциях, серверах, сетевом оборудовании и других устройствах подключенных к защищаемой сети. Проводите анализ типов угроз, уязвимостей, программ-эксплойтов, которые можно использовать против защищаемой организации. Так же рекомендуется применение систем защиты от эксплойтов, например, [Windows Defender Exploit Guard (WDEG)](https://docs.microsoft.com/ru-ru/windows/security/threat-protection/windows-defender-exploit-guard/windows-defender-exploit-guard) для Windows 10 или [Enhanced Mitigation Experience Toolkit (EMET)](https://support.microsoft.com/ru-ru/help/2458544/the-enhanced-mitigation-experience-toolkit) для более ранних версий Windows.

h3[EWM-инъекции (Extra Window Memory Injection)](https://attack.mitre.org/wiki/Technique/T1181)  
_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Техника заключается в злоупотреблении дополнительной памятью окна Windows, так называемой Extra Window Memory (EWM). Размер EWM — 40 байт, подходит для хранения 32-битного указателя и часто используется для указания ссылки на процедуры. Вредоносные программы в ходе цепочки атаки, могут размещать в EWM указатель на вредоносный код, который в последствие будет запущен процессом инфицированного приложения.

_Рекомендации по защите:_ Учитывая, что техники EWM-инъекций основаны на злоупотреблении функциями разработки ОС усилия по защите необходимо направить на предотвращение запуска вредоносных программ и инструментов злоумышленников. Хорошей практикой является выявление и блокирование потенциально-опасного ПО с помощью AppLocker, организации белого списка приложений или применения политик ограничения программного обеспечения Software Restriction Policies.

### [Недостатки разрешений на уровне файловой системы (File System Permissions Weakness)](https://attack.mitre.org/wiki/Technique/T1044)

_Система:_ Windows  
_Права:_ Пользователь, Администратор  
_Описание:_ Суть техники заключается в подмене исполняемых файлов, которые автоматически запускаются различными процессами (например, при загрузке ОС или в определенное время, в случае если права на исполняемые файлы настроены неверно). После подмены вредоносный файл будет запущен с правами процесса, таким образом если процесс имеет более высокий уровень доступа злоумышленник сможет осуществить эскалацию привилегий. В рамках данной техники злоумышленники могут пытаться манипулировать двоичными файлами служб Windows.  
Другой вариант атаки связан с недостатками алгоритмов в работе самораспаковывающихся установщиков. В процессе инсталляции ПО, установщики зачастую распаковывают различные полезные файлы, в том числе .dll и .exe, в каталог %TEMP%, при этом они могут не устанавливать соответствующие разрешения для ограничения доступа к распаковываемым файлам, что позволяет злоумышленникам совершать подмену файлов и, как следствие, повысить привилегии или обойти контроль учетных записей, т.к. некоторые установщики выполняются с расширенными правами.

_Рекомендации по защите:_ Ограничение прав учетных записей, чтобы только администраторы могли управлять службами и взаимодействовать с бинарными файлами, используемыми службами. Отключение в UAC возможности повышения привилегий для стандартных пользователей. Параметры UAC хранятся в следующем разделе реестра:

*   _\[HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\]_.

Для автоматического отклонения запросов на повышение привилегий необходимо добавить ключ:

*   _«ConsentPromptBehaviorUser»=dword:00000000._

Для контроля работы установщиков необходимо добавить ключ:

*   _«EnableInstallerDetection»=dword:00000001_, который будет требовать ввода пароля для установки программ.

### [Перехват вызовов функций Windows API (Hooking)](https://attack.mitre.org/wiki/Technique/T1179)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ API функции Windows обычно хранятся в DLL-библиотеках. Техника Hooking заключается в перенаправлении вызовов API-функций посредством:

*   Hook-процедур — встроенных в ОС процедур, которые выполняют код при вызове различных событий, например, нажатие клавиш или перемещение мыши;
*   Модификации адресной таблицы (IAT), в которой хранятся указатели на API-функции. Это позволит «обмануть» атакуемое приложение, заставив его запустить вредоносную функцию;
*   Непосредственного изменения функции (сплайсинг), в ходе которого меняются первые 5 байт функции, вместо которых вставляется переход на вредоносную или иную функцию, определенную злоумышленником.

Подобно инъекциям, злоумышленники могут использовать hooking для исполнения вредоносного кода, маскировки его выполнения, доступа к памяти атакуемого процесса и повышения привилегий. Злоумышленники могут захватывать вызовы API, включающие параметры, содержащие аутентификационные данные. Hooking обычно применяется руткитами для скрытия вредоносной активности в системе.

_Рекомендации по защите:_ Перехват событий в ОС является частью нормальной работы системы, поэтому какое либо ограничение данной функциональности может негативно влиять на стабильность работы законных приложений, например антивирусного ПО. Усилия по предотвращению применения техник перехвата необходимо сосредоточить на более ранних этапах цепочки атаки. Обнаружить вредоносную hooking-активность можно с помощью мониторинга вызовов функций SetWindowsHookEx и SetWinEventHook, использования детекторов руткитов, анализа аномального поведения процессов.

### [IFEO-инъекции (Image File Execution Options Injection)](https://attack.mitre.org/wiki/Technique/T1183)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Механизм Image File Execution Options (IFEO) позволяет запускать вместо программы её отладчик, заранее указанный разработчиком в реестре:

*   _HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options/\[executable\]_
*   _HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\\[executable\]_, где _\[executable\]_ — это исполняемый двоичный файл отладчика.

Подобно инъекциям, значением _\[executable\]_ можно злоупотреблять запуская произвольный код, чтобы повысить привилегии или закрепиться в системе. Вредоносные программы могут использовать IFEO на для обхода защиты, регистрируя отладчики, которые перенаправляют и отклоняют различные системные приложения и приложения безопасности.

_Рекомендации по защите:_ Описываемая техника основана на злоупотреблении штатными средствами разработки ОС, поэтому какие-либо ограничения могут вызвать нестабильность работы законного ПО, например, приложений безопасности. Усилия по предотвращению применения техники IFEO-инъекций необходимо сосредоточить на более ранних этапах цепочки атаки. Обнаружить подобную атаку можно с помощью мониторинга процессов с флагами _Debug_process_ и _Debug\_only\_this_process_.

### [Запуск демонов (Launch Daemon)](https://attack.mitre.org/wiki/Technique/T1160)>

_Система:_ macOS  
_Права:_ Администратор  
_Описание:_ Техника заключается в изменении злоумышленником параметров сервисов системного уровня запуска — Launch Daemon, указанных в plist-файлах. При загрузке системы процесс Launchd загружает параметры сервисов (демонов) из plist-файлов расположенных в следующих директориях:

*   /System/Library/LaunchDeamons;
*   /Library/LaunchDeamons.

Launch Daemon могут создаваться с администраторскими привилегиями, но выполнятся под учетной записью root, таким образом злоумышленник может реализовать эскалацию привилегий. Разрешения plist-файлов должны быть root:while, однако сценарий или программа, указанные в нём, могут иметь менее строгие разрешения. Поэтому злоумышленник может изменить исполняемые файлы, указанные в plist, и, таким образом, модифицировать текущие системные сервисы для закрепления в системе или эскалации привилегий.

_Рекомендации по защите:_ Ограничьте привилегии пользователей, чтобы только авторизованные администраторы могли создавать Launch Daemon. Рассмотрите возможность мониторинга создания в системе plist-файлов с помощью таких приложений как KnockKnock.

### [Новые службы (New Service)](https://attack.mitre.org/wiki/Technique/T1050)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Имя доступ в систему, злоумышленники могут создавать новые службы и настраивать их автоматический запуск. Имя службы может быть замаскировано с использованием имён, характерных для операционной системы. Службы могут быть созданы с привилегиями администратора, но запускаться от имени System. Сервисы могут создаваться из командной строки, с помощью средств удаленного доступа с функциями взаимодействия с Windows API или с помощью стандартных средств управления Windows и PowerShell.

_Рекомендации по защите:_ Ограничьте права пользователей на создание новых служб, чтобы только уполномоченные администраторы могли это делать. Применяйте AppLocker и [Software Restriction Policy](https://technet.microsoft.com/en-us/library/2008.06.srp.aspx).

### [Перехват пути (Path Interception)](https://attack.mitre.org/wiki/Technique/T1034)

_Система:_ Windows  
_Права:_ Пользователь, администратор, system  
_Описание:_ Техника перехвата пути заключается в помещении исполняемого файла в директорию, из которой приложение запустит его вместо целевого файла. Атакующий может использовать следующие методы:

*   Несуществующие пути. Пути к исполняемым файлам служб хранятся в ключах реестра и могут иметь один или несколько пробелов, например, _C:\\Program Files\\service.exe_, если атакующий создаст в системе файл _C:\\Program.exe_, то Windows при обработке пути запустит его вместо целевого файла службы.
*   Неправильная конфигурация переменных окружения. Если в переменной PATH путь _C:\\example_ предшествует _c:\\Windows\\System32_ и существует файл _C:\\example\\net.exe_, то при вызове команды net, будет выполнен _C:\\example\\net.exe_, а не _c:\\Windows\\System32\\net.exe_.
*   Перехват порядка поиска (Search order hijacking). Когда не задан полный путь к исполняемому файлу, Windows, как правило, ищет файл с указанным именем в текущем каталоге, затем осуществляет поиск в системных каталогах. Например, файл «example.exe» при выполнении запускает cmd.exe с аргументами для выполнения команды net use. Атакующий может поместить в каталог расположения example.exe файл net.exe и он будет запущен вместо утилиты _c:\\Windows\\System32\\net.exe_. Кроме того, если атакующий поместит файл net.com в каталог с файлом net.exe, то Windows выполнит net.com в соответствии с порядком исполнения, определенном в системной переменной PATHEXT.

_Перехват порядка поиска файлов также применяется для выполнения DLL с помощью техники [DLL Search Hijacking](https://attack.mitre.org/wiki/Technique/T1038)._

_Рекомендации по защите:_ Выделите кавычками пути, указанные в файлах конфигураций, сценариях, переменной PATH, настройках служб и ярлыках. Помните о порядке поиска исполняемых файлов и используйте только полные пути. Выполните очистку старых ключей реестра, оставшихся от удаленного ПО, чтобы в реестре не осталось ключей, указывающих на несуществующие файлы. Установите запрет на запись пользователями системы в корневой каталог С:\ и системные каталоги Windows, ограничивайте права на запись в каталоги с исполняемыми файлами.

### [Модификация файлов Plist (Plist Modification)](https://attack.mitre.org/wiki/Technique/T1150)

_Система:_ macOS  
_Права:_ Пользователь, Администратор  
_Описание:_ Злоумышленники могут модифицировать plist-файлы, указывая в них собственный код для его исполнения в контексте другого пользователя. Файлы свойств plist, расположенные в _/Library/Preferences_ выполняются с повышенными привилегиями, а plist из _~/Library/Preferences_ выполняются с привилегиями пользователя.

_Рекомендации по защите:_ Предотвратите изменение файлов plist, сделав их доступными только на чтение.

### [Модификация Port Monitors в Диспетчере печати (Port Monitors)](https://attack.mitre.org/wiki/Technique/T1013)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Атакующий может организовать выполнение произвольной DLL от имени System при каждой загрузке Windows с помощью злоупотребления настройками Диспетчера печати (Spoolsv.exe). Для взаимодействия с устройствами печати Spoolsv.exe использует так называемые мониторы порта (port monitor) — это DLL-библиотеки, с помощью которых посредством LAN, USB, LPT или COM-интерфейса на устройства печати передаются низкоуровневые команды. Вышеописанные DLL хранятся в _C:\\windows\\system32_ и регистрируются в реестре:  
_HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print\\Monitors_.  
Port Monitor можно установить с помощью API функции AddMonitor или напрямую через редактирование вышеуказанного раздела реестра.

_Рекомендации по защите:_ Организуйте блокирование потенциально-опасного ПО и применяйте инструменты контроля запуска приложений.

### [Инъекция кода в процесс (Process Injection),](https://attack.mitre.org/wiki/Technique/T1055) [Ten Process Injection Techniques](https://www.endgame.com/blog/technical-blog/ten-process-injection-techniques-technical-survey-common-and-trending-process)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь, администратор, system, root  
_Описание:_ Процессные инъекции — это метод выполнения произвольного кода в адресном пространстве отдельно живущего процесса. Запуск кода в контексте другого процесса позволяет получить доступ к памяти инъецируемого процесса, системным/сетевым ресурсам и, возможно, повышенные привилегии. Процессные инъекции также могут использоваться во избежание возможного обнаружения вредоносной активности средствами безопасности. Техники реализации инъекций в процессы основны на злоупотреблении различными механизмами, обеспечивающими многопоточность выполнения программ в ОС. Далее рассмотрены некоторые подходы к выполнению инъекции кода в процесс.

**Windows**  
• DLL-инъекции. Выполняются посредством записи пути к вредоносной DLL внутрь процесса с её последующим выполнением путём создания удаленного потока (Remote thread — поток, который работает в виртуальном адресном пространстве другого процесса). Иными словами, вредоносное ПО записывает на диск DLL, а затем использует функцию подобную CreateRemoteTread, с помощью которой будет вызвана функция LoadLibrary в инъецируемом процессе.  
• PE-инъекции (Portable executable injection) основаны на злоупотреблении особенностями выполнения в памяти PE-файлов, таких как DLL или EXE. Вредоносный код записывается в процесс без записи каких-либо файлов на диске, а затем с помощью дополнительного кода или путем создания удаленного потока вызывается его исполнение.  
• Захват выполнения потока (Thread execution hijacking) включает в себя инъекции вредоносного кода или пути к DLL напрямую в поток процесса. Подобно технике Process Hollowing, поток сначала должен быть приостановлен.  
• Инъекции в процедуры асинхронного вызова (Asynchronous Procedure Call (APC) injection) предполагают вложение вредоносного кода в очередь APC-процедур (APC Queue) потока процесса. Один из способов APC-инъекций, получивший название «Инъекция ранней пташки (Earle Bird injection)», предполагает создание приостановленного процесса в котором вредоносный код может быть записан и запущен до точки входа процесса через APC. AtomBombing — это другой вариант инъекции, который использует APC для вызова вредоносного кода, ранее записанного в глобальную таблицу атомов (Global atom table).  
• Инъекции в локальное хранилище потока (Thread Local Storage (TLS) injection) предполагают манипуляции с указателями памяти внутри исполняемого PE-файла для перенаправления процесса на вредоносный код.

**Mac и Linux**  
• Системные переменные LD\_RPELOAD, LD\_LIBRARY\_PATH (Linux), DYLIB\_INSERT_LIBRARIES (macOS X) или интерфейс прикладного программирования dlfcn (API) могут использоваться для динамической загрузки библиотеки (общего объекта) в процесс, который в свою очередь может использоваться для перехвата вызовов API из запущенных процессов.  
• Системный вызов Ptrace может использоваться для подключения к запущенному процессу и изменения во время его выполнения.  
• /proc/\[pid\]/mem обеспечивает доступ к памяти процесса и может использоваться для чтения/записи произвольных данных, однако такой метод редко применяется из-за сложности его реализации.  
• Захват VDSO (Virtual dynamic shared object) позволяет осуществить инъекцию кода во время исполнения двоичных файлов ELF, манипулируя заглушками кода из linux-vdso.so.  
Вредоносные программы обычно используют инъекции кода в процесс для доступа к системным ресурсам, благодаря которым злоумышленник может закрепиться в системе и выполнять другие изменения в атакуемой среде. Более сложные образцы могут выполнять множественные инъекции процессов для затруднения своего обнаружения.

_Рекомендации по защите:_ Методы инъецирования кода в процессы основаны на злоупотреблении штатными функциями ОС прямое воздействие на которые может привести к нестабильной работе законного ПО и продуктов безопасности. Усилия по предотвращению применения техник перехвата необходимо сосредоточить на более ранних этапах цепочки атаки. Применяйте инструменты блокировки потенциально-опасного ПО, такие как AppLocker. Применяйте Yama в качестве превентивной меры от инъекций кода в ptrace, ограничив использование ptrace только привилегированными пользователями. Дополнительные меры защиты могут включать развертывание модулей безопасности ядра, обеспечивающих расширенный контроль доступа и ограничение процессов. К таким средствам относятся SELinux, grsecurity, AppArmor.

### [Инъекции в SID-истории (SID-History Injection)](https://attack.mitre.org/wiki/Technique/T1178)

_Система:_ Windows  
_Права:_ Администратор, система  
_Описание:_ Всякий раз, когда объект перемещается из одного домена в другой создается новый SID, который становится основным objectSID. Предыдущие SID продолжают храниться в свойстве sIDHistory, таким образом обеспечивая сохранение прав, которые имел объект до междоменной миграции. Злоумышленники, при наличии прав администратора, могут вставлять в SID-History собранные ранее SID, чтобы выполнить действие от имени более привилегированных групп доступа или учетных записей, такие как администраторы домена.

_Рекомендации по защите:_ В ОС Windows Server версии 2003 и выше по умолчанию включена Фильтрация SID (SID Filtering), которая предполагает удаление или фильтрацию всех SID, кроме доверенного домена, однако данная опция может быть умышленно отключена, чтобы разрешить междоменный доступ.  
Основные способы фильтрации SID:  
• Отключение SIDHistory в параметрах доверительных отношений (трастов) между лесами доменов с помощью команды: _netdom trust /domain: /EnableSIDHistory:no_;  
• Применение [SID Filter Quarantining](https://msdn.microsoft.com/en-us/windows/desktop/cc755427). Это гарантирует, что объект, содержащий SID, отличный от доверенного домена, не сможет пройти аутентификацию в доверяющем домене. SID Filter Quarantining применяется для внешних трастов с помощью выполнения команды: _netdom trust /domain: /quarantine:yes_.  
Применение SID Filtering между доменами одного леса не рекомендуется. Если домен в лесу ненадёжен, то он не должен быть членом леса, в такой ситуации необходимо сначала разделить доверенные и ненадежные домены на отдельные леса, а затем применить SID Filtering для трастов между лесами.

### [Планирование задач (Scheduled Task)](https://attack.mitre.org/wiki/Technique/T1053)

_Система:_ Windows  
_Права:_ Пользователь, администратор, система  
_Описание:_ Такие утилиты как at, schtasks и Планировщик задач Windows могут использоваться для планирования запуска программ и сценариев, которые будут выполнятся в определенную дату и время. Задачу можно запланировать в удаленной системе, при условии, что для проверки подлинности используется RPC, и включен общий доступ к принтерам и файлам. Планирование задач в удаленной системе требует прав администратора. Злоумышленник может использовать удаленное выполнение кода для получения прав System или для запуска процесса под определенной учетной записью.

_Рекомендации по защите:_ Ограничение привилегий пользователей. Применение инструментов, таких как модуль PowerUP в PowerSploit, которые могут использоваться для поиска слабых мест в разрешениях запланированных задач. Отключение возможности запуска задач от имени System, отключение в политике безопасности параметра "_Разрешить операторам сервера планировать задачи_" и включение параметра "_Назначение прав пользователя: Увеличить приоритет планирования_".

### [Слабости разрешений параметров служб в реестре (Service Registry Permissions Weakness)](https://attack.mitre.org/wiki/Technique/T1058)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Если разрешения пользователей и групп позволяют изменять в реестре Windows значения ключей, в которых хранятся параметры служб, то злоумышленники могут напрямую модифицировать ключи, в которых хранятся пути к исполняемым файлам запуска служб или использовать различные инструменты управления службами — sc.exe, PowerShell или Reg. Атакующие так же могут менять параметры, связанные с отказом служб, например, FailureCommand, указывающие команду, которая будет выполнятся в случае отказа или преднамеренного повреждения службы. Параметры служб хранятся в _HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\services_.

_Рекомендации по защите:_ Убедитесь, что пользователи защищаемой системы не могут изменять в реестре ключи, хранящие параметры системных компонентов. Используйте всевозможные средства блокирования потенциально-опасного ПО, например, Windows AppLocker.

### [Setuid и Setgid](https://attack.mitre.org/wiki/Technique/T1166)

_Система:_ Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Setuid и Setgid — это флаги прав доступа в Unix-системах, которые разрешают пользователю запускать исполняемые файлы с правами владельца или группы исполняемого файла. Если приложение необходимо запустить от имени root, то вместо того, чтобы создавать запись в файле sudo, пользователь может указать флаг Setuid или Setgid. Противники могут злоупотреблять флагами Setuid и Setgid чтобы выполнить shell escape (приём, когда в консольном режиме какое-либо приложение использует файл открытый в другом приложении) либо воспользоваться уязвимостью приложения с флагами Setuid и Setgid и выполнить код в контексте различных пользователей. При просмотре атрибутов файла командой ls -l вышеописанные флаги обозначаются символом «s» вместо «x». Утилита chmod может устанавливать флаги Setuid и Setgid с помощью команды _chmod 4777 \[файл\]_ или _chmod u + s \[файл\]_.

_Рекомендации по защите:_ Сведите количество программ с установленными флагами Setuid и Setgid к минимуму.

### [Элементы автозапуска (Startup Items)](https://attack.mitre.org/wiki/Technique/T1165)

_Система:_ macOS  
_Права:_ Администратор  
_Описание:_ Атакующий может использовать устаревший, но до сих пор работающий в macOS Sierra, механизм автозапуска приложений с помощью StartupItems для настройки запуска своего кода с правами root во время загрузки ОС. StartupItems — это каталог в _/Library/Startupitems_, командный сценарий и файл свойств StartupParameters.plist. Сценарий и файл свойств должны находится на верхнем уровне иерархии: _/Library/Startupitems/\[MyStartupItem\]_.

_Рекомендации по защите:_ Поскольку механизм StartupItems является устаревшим, то запрет записи в каталоге _/Library/Startupitems/_ позволит избежать создания элементов автозагрузки.

### [Sudo](https://attack.mitre.org/wiki/Technique/T1169)

_Система:_ Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Противники могут пользоваться недостатками конфигурации Sudo для выполнения команд от имени других пользователей или порождения процессов с более высокими привилегиями. Параметры Sudo хранятся в файле _/etc/sudoers_, для редактирования этого файла необходимы повышенные привилегии. Файл sudoers описывает какие команды пользователи могут запускать от имени других пользователей или групп, это позволяет пользователям работать большую часть времени с минимальными правами и только при необходимости повышать привилегии. Однако, в файле sudoers можно указать пользователей, для которых пароль запрашиваться не будет: _username ALL=(ALL) NOPASSWD: ALL_.

_Рекомендации по защите:_ Файл sudoers должен быть отредактирован так, чтобы пользователи всегда вводили пароль при выполнении Sudo. Auditd в Linux может генерировать предупреждение всякий раз, когда реальный и эффективный ID пользователя не совпадают (это происходит, когда пользователь использует sudo).

### [Sudo Caching](https://attack.mitre.org/wiki/Technique/T1206)

_Система:_ Linux, macOS  
_Права:_ User  
_Описание:_ Различные вредоносные программы, как, например, [_OCX Proton Malware_](https://www.cybereason.com/blog/labs-proton-b-what-this-mac-malware-actually-does), могут злоупотреблять настройками sudo, чтобы выполнить код от имени root без ввода пароля. Поскольку инструментарий sudo был создан для системного администрирования в нём есть некоторые полезные функции такие как _timestamp_timeout_ — этот параметр хранит количество времени в минутах между запусками sudo в течение которого команда не будет запрашивать ввод пароля root. Sudo имеет возможность кэширования учетных данных в течение некоторого времени. Отметка о времени последнего запуска Sudo хранится в _/var/db/sudo_ и служит для определения заданного таймаута. Кроме того, существует переменная _tty_tickets_, которая обрабатывает каждый новый сеанс терминала изолированно, таким образом таймаут в одном экземпляре консоли не повлияет на таймаут в другом экземпляре.

_Рекомендации по защите:_ Установите значение параметра _timestamp_timeout = 0_, чтобы система требовала ввод пароля root при каждом выполнении sudo. Включите параметр _tty_tickets_, чтобы предотвратить возможность реализации атаки через сеансы командной консоли.

### [Valid Accounts](https://attack.mitre.org/wiki/Technique/T1078)

_Описание:_ Злоумышленники могут украсть учетные данные определенного пользователя или учетную запись службы с помощью техник доступа к учетным данным, захватить учетные данные в процессе разведки с помощью социальной инженерии. Скомпрометированные учетные данные могут использоваться для обхода систем управления доступом и получения доступа к удаленным системам и внешним службам, таким как VPN, OWA, удаленный рабочий стол или получения повышенных привилегий в определенных системах и областях сети. В случае успешной реализации сценария злоумышленники могут отказаться от вредоносных программ, чтобы затруднить своё обнаружение. Так же злоумышленники могут создавать учетные записи используя заранее определенные имена и пароли для сохранения резервного доступа в случае неудачных попыток использования других средств.

_Рекомендации по защите:_ Применение парольной политики, следование рекомендациям по проектированию и администрированию корпоративной сети для ограничения использования привилегированных учетных записей на всех административных уровнях. Регулярные проверки доменных, локальных учетных записей и их прав с целью выявления тех, которые могут позволить злоумышленнику получить широкий доступ. Мониторинг активности учетных записей с помощью SIEM-систем.

### [Web Shell](https://attack.mitre.org/wiki/Technique/T1100)

_Система:_ Windows, Linux, macOS  
_Описание:_ Web Shell может использоваться злоумышленником в качестве шлюза доступа в вашу сеть или избыточного доступа в атакуемую систему, как резервного механизма закрепления в случае обнаружения и блокирования основных каналов доступа в атакуемую среду.

_Рекомендации по защите:_ Убедитесь, что ваши внешние веб-серверы регулярно обновляются и не имеют известных уязвимостей, которые позволяют злоумышленникам загрузить на сервер файл или сценарий с последующим исполнением. Проверьте, что разрешения учетных записей и групп с правами управления серверами не совпадают с учетными записями внутренней сети, которые могут быть использованы для входа на веб-сервер, запуска Web shell или закрепления на Web-сервере. Web Shell трудно обнаружить, т.к. они не инициируют подключения и их серверная часть может быть маленькой и безобидной, например, PHP-версия оболочки China Chopper Web выглядит как строчка:  
_\[?php [eval](https://habr.com/users/eval/)($_POST \['password'\]);\]_